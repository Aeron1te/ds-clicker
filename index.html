<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Soulforge ‚Äî –∫–ª–∏–∫–µ—Ä —Ç—ë–º–Ω–æ–≥–æ –ø–ª–∞–º–µ–Ω–∏</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- jQuery (CDN, –±–µ–∑ –ø—Ä–æ–±–ª–µ–º–Ω–æ–≥–æ SRI) -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

  <!-- –ê—Ç–º–æ—Å—Ñ–µ—Ä–Ω—ã–µ —à—Ä–∏—Ñ—Ç—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Spectral+SC:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #0b0b0d;
      --bg-2: #101014;
      --panel: #141418;
      --panel-2:#1a1a20;
      --text:#d6d6d6;
      --muted:#9b9b9b;
      --gold:#c9a96e;
      --ember:#ff6a00;
      --ember-2:#ffb347;
      --accent:#9e4b00;
      --danger:#cf4b4b;
      --good:#58c47a;
      --shadow: rgba(0,0,0,0.55);
    }

    *{box-sizing:border-box}
    html,body{
      margin:0; padding:0;
      background: radial-gradient(1200px 800px at 60% -10%, rgba(255,110,20,0.05), transparent 60%),
                  radial-gradient(800px 600px at 20% 110%, rgba(255,160,40,0.04), transparent 60%),
                  var(--bg);
      color:var(--text);
      font-family: "Spectral SC", Georgia, "Times New Roman", serif;
      text-rendering: optimizeLegibility;
      -webkit-font-smoothing: antialiased;
    }
    .noise{
      pointer-events:none;
      position:fixed; inset:0;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" opacity="0.05"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="2"/></filter><rect width="100%" height="100%" filter="url(%23n)"/></svg>');
      mix-blend-mode: soft-light;
      z-index:0;
    }
    header{
      position:sticky; top:0; z-index:5;
      background: linear-gradient(180deg, rgba(10,10,12,0.9), rgba(10,10,12,0.6), rgba(10,10,12,0));
      backdrop-filter: blur(2px);
      padding: 12px 16px 8px;
      border-bottom: 1px solid rgba(201,169,110,0.12);
    }
    .title{
      display:flex; align-items:baseline; gap:10px; flex-wrap:wrap;
    }
    .title h1{
      margin:0; font-family:"Cinzel", serif; letter-spacing:1px;
      color:var(--gold); font-weight:700; text-shadow: 0 0 12px rgba(201,169,110,0.25);
      font-size: clamp(22px, 4.5vw, 38px);
    }
    .title .subtitle{
      color: var(--muted); font-size: 14px; opacity:0.9;
    }
    .bar{
      margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .stat{
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border:1px solid rgba(201,169,110,0.2);
      border-radius:10px; padding:10px 12px;
      display:flex; gap:10px; align-items:baseline;
      box-shadow: 0 8px 20px -12px var(--shadow) inset, 0 1px 0 rgba(255,255,255,0.03);
    }
    .stat .label{ color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:1px;}
    .stat .value{ font-size:16px; font-weight:600; color:#f0f0f0 }

    .prestige-btn{
      margin-left:auto;
      background: linear-gradient(180deg, #22150a, #1b1108);
      color:var(--gold);
      border:1px solid rgba(201,169,110,0.35);
      border-radius:10px; padding:10px 14px; font-weight:600;
      cursor:pointer; transition: all .2s ease;
      text-shadow:0 0 10px rgba(255,120,40,0.2);
      box-shadow: 0 0 20px -12px rgba(255,110,20,0.6) inset, 0 8px 28px -20px rgba(255,110,20,0.4);
    }
    .prestige-btn:hover{ transform: translateY(-1px); box-shadow: 0 0 24px -10px rgba(255,110,20,0.7) inset, 0 10px 32px -18px rgba(255,110,20,0.45); }
    .prestige-btn:disabled{ filter:grayscale(0.4); opacity:0.6; cursor:not-allowed }

    .wrap{
      position:relative;
      max-width:1200px; margin: 14px auto; padding: 0 16px; z-index:1;
      display:grid; grid-template-columns: 1.1fr 1fr; gap:16px;
    }
    @media (max-width: 980px){
      .wrap{ grid-template-columns: 1fr; }
    }

    .panel{
      background: linear-gradient(180deg, rgba(20,20,24,0.85), rgba(16,16,20,0.95));
      border:1px solid rgba(201,169,110,0.15);
      border-radius:14px; overflow:hidden;
      box-shadow: 0 10px 40px -24px black, 0 0 0 1px rgba(255,255,255,0.02) inset;
    }
    .panel h2{
      margin:0; padding:14px 16px;
      border-bottom:1px solid rgba(201,169,110,0.12);
      font-family:"Cinzel", serif; font-size:18px; color: var(--gold);
      display:flex; align-items:center; justify-content:space-between;
    }
    .panel .body{ padding:16px; }

    /* –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∑–æ–Ω–∞ –∫–ª–∏–∫–∞ */
    .bonfire-wrap{
      display:flex; align-items:center; justify-content:center;
      min-height: 420px; position:relative; overflow:hidden;
      background:
        radial-gradient(320px 160px at 55% 30%, rgba(255,120,40,0.05), transparent 60%),
        linear-gradient(180deg, rgba(255,120,40,0.05), rgba(0,0,0,0));
    }
    .bonfire{
      width: 230px; height: 230px;
      border-radius: 50%;
      background:
        radial-gradient(120px 80px at 50% 38%, rgba(255,120,40,0.12), rgba(255,120,40,0) 70%),
        radial-gradient(90px 40px at 50% 62%, rgba(255,120,40,0.12), rgba(255,120,40,0) 70%),
        linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0) 50%),
        #0f0f12;
      border:1px solid rgba(201,169,110,0.2);
      box-shadow:
        0 0 80px -24px rgba(255,110,20,0.55),
        0 10px 60px -28px rgba(255,110,20,0.45) inset,
        0 0 0 1px rgba(255,255,255,0.02) inset;
      position:relative; cursor:pointer; transition: transform .06s ease;
      display:flex; align-items:center; justify-content:center;
      user-select:none; -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .bonfire:active{ transform: scale(0.98) translateY(1px); }
    .bonfire .embers{
      position:absolute; inset:0; overflow:visible; pointer-events:none;
    }
    .flame{
      position:absolute; bottom:58px; left:50%; transform:translateX(-50%);
      width: 60px; height: 90px; border-radius: 50% 50% 40% 40%;
      background: radial-gradient(ellipse at 50% 70%, var(--ember) 0%, rgba(255,120,40,0.9) 25%, rgba(255,120,40,0.5) 55%, rgba(255,120,40,0.0) 75%);
      filter: blur(0.4px) drop-shadow(0 0 12px rgba(255,110,20,0.55));
      animation: flamePulse 1.8s ease-in-out infinite;
      opacity:0.92;
    }
    .flame:after{
      content:""; position:absolute; inset: 14% 20% 24% 20%;
      border-radius:50% 50% 40% 40%;
      background: radial-gradient(ellipse at 50% 50%, #ffd5a1 0%, rgba(255,200,140,0.0) 70%);
      filter: blur(2px);
      opacity:0.9;
    }
    @keyframes flamePulse{
      0%,100%{ transform:translateX(-50%) scale(1); opacity:0.94 }
      50%{ transform:translateX(-50%) scale(1.06); opacity:1 }
    }
    .logs{
      position:absolute; bottom:40px; left:50%; transform:translateX(-50%);
      width:120px; height: 40px; border-radius: 20px / 14px;
      background: linear-gradient(180deg, #1b1b20, #141418);
      box-shadow: 0 8px 24px -12px rgba(0,0,0,0.6) inset;
      border:1px solid rgba(201,169,110,0.15);
    }

    .click-float{
      position:absolute; pointer-events:none;
      color:#ffd7a3; font-weight:700; text-shadow:0 0 10px rgba(255,120,40,0.8);
      animation: floatUp .8s ease-out forwards;
      font-family:"Cinzel", serif;
      filter: drop-shadow(0 6px 16px rgba(0,0,0,0.8));
    }
    @keyframes floatUp{
      0%{ transform: translate(-50%, 0); opacity:1 }
      100%{ transform: translate(-50%, -40px); opacity:0 }
    }

    .ember-spark{
      position:absolute; width:6px; height:6px; border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #ffd2a0, var(--ember));
      box-shadow: 0 0 12px 2px rgba(255,110,20,0.35);
      animation: spark 1.1s ease-out forwards;
      pointer-events:none; opacity:0.9;
    }
    @keyframes spark{
      0%{ transform: translate(0,0) scale(1); opacity:0.9 }
      100%{ transform: translate(var(--dx), var(--dy)) scale(0.6); opacity:0 }
    }

    /* –ú–∞–≥–∞–∑–∏–Ω */
    .shop{
      display:grid; grid-template-columns: 1fr; gap:10px;
    }
    .item{
      display:grid; grid-template-columns: 1fr auto; gap:10px;
      align-items:center;
      background: linear-gradient(180deg, #141418, #101016);
      border:1px solid rgba(201,169,110,0.15); border-radius:12px; padding:12px;
    }
    .item .name{ font-weight:600; color:#f0f0f0; font-family:"Cinzel", serif; }
    .item .desc{ color:var(--muted); font-size:12px; margin-top:4px; }
    .item .meta{ display:flex; gap:10px; color:var(--muted); font-size:12px; margin-top:6px }
    .buy{
      background: linear-gradient(180deg, #1a1410, #100c09);
      color:var(--gold);
      border:1px solid rgba(201,169,110,0.35);
      border-radius:10px; padding:10px 12px; cursor:pointer; font-weight:700;
      min-width:110px; text-align:center;
      transition: all .15s ease;
    }
    .buy:hover{ transform: translateY(-1px); box-shadow: 0 8px 24px -16px rgba(255,110,20,0.4) }
    .buy:disabled{ filter:grayscale(0.5); opacity:0.6; cursor:not-allowed }

    /* –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∏ –ª–æ–≥ */
    .achievements{
      display:flex; flex-wrap:wrap; gap:8px;
    }
    .badge{
      background: linear-gradient(180deg, #131316, #0f0f13);
      border:1px solid rgba(201,169,110,0.18);
      color:#f1e6d2;
      border-radius:12px; padding:8px 10px; font-size:12px;
      box-shadow: 0 8px 24px -16px rgba(255,110,20,0.2) inset;
    }
    .toast{
      position:fixed; right:16px; bottom:16px; z-index:1000;
      background: linear-gradient(180deg, #1b1510, #121015);
      color:#ffe8c8; border:1px solid rgba(201,169,110,0.35);
      border-radius:12px; padding:12px 14px; min-width:240px;
      box-shadow: 0 10px 40px -20px rgba(0,0,0,0.8), 0 0 0 1px rgba(255,255,255,0.02) inset;
      display:none;
    }

    /* –ü–æ–¥–≤–∞–ª/—Å–æ–≤–µ—Ç—ã */
    .tips{
      color:var(--muted); font-size:12px; line-height:1.5;
      padding: 0 16px 16px; text-align:center;
    }
    a,button{ outline:none }
    ::selection{ background: rgba(255,120,40,0.28) }
  </style>
</head>
<body>
  <div class="noise" aria-hidden="true"></div>
  <header>
    <div class="title">
      <h1>SOULFORGE</h1>
      <div class="subtitle">–ö–æ—Å—Ç—ë—Ä –ø–æ–º–Ω–∏—Ç –∫–∞–∂–¥—É—é –¥—É—à—É</div>
    </div>
    <div class="bar">
      <div class="stat"><div class="label">–î—É—à–∏</div><div class="value" id="souls">0</div></div>
      <div class="stat"><div class="label">–ó–∞ –∫–ª–∏–∫</div><div class="value" id="spc">1</div></div>
      <div class="stat"><div class="label">–í —Å–µ–∫.</div><div class="value" id="sps">0</div></div>
      <div class="stat"><div class="label">–£–≥–ª–∏</div><div class="value" id="embers">0</div></div>
      <button class="prestige-btn" id="prestigeBtn" disabled>–°–≤—è–∑–∞—Ç—å –ü–ª–∞–º—è (+0% –¥—É—à–∏) ‚Äî –ü—Ä–µ—Å—Ç–∏–∂</button>
    </div>
  </header>

  <div class="wrap">
    <div class="panel">
      <h2>–ö–æ—Å—Ç—ë—Ä ‚Äî –ö–ª–∏–∫–Ω–∏—Ç–µ, —á—Ç–æ–±—ã —Ä–∞–∑–∂–µ—á—å</h2>
      <div class="body bonfire-wrap">
        <div class="bonfire" id="bonfire" aria-label="–ö–ª–∏–∫–Ω—É—Ç—å –∫–æ—Å—Ç—ë—Ä">
          <div class="flame"></div>
          <div class="logs"></div>
          <div class="embers" id="embersLayer"></div>
        </div>
      </div>
    </div>

    <div class="panel">
      <h2>–ú–∞–≥–∞–∑–∏–Ω</h2>
      <div class="body shop" id="shop">
        <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º -->
      </div>
    </div>

    <div class="panel" style="grid-column: 1 / -1;">
      <h2>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∏ —Å–æ–±—ã—Ç–∏—è</h2>
      <div class="body">
        <div class="achievements" id="achievements"></div>
      </div>
    </div>
  </div>

  <div class="tips">
    –°–æ–≤–µ—Ç: –¥–æ–ª–≥–∏–µ —Ü–µ–ø–æ—á–∫–∏ –∫–ª–∏–∫–æ–≤ —Ä–∞—Å–∫–∞–ª—è—é—Ç —É–≥–ª–∏. –ü—Ä–µ—Å—Ç–∏–∂ ¬´–°–≤—è–∑–∞—Ç—å –ü–ª–∞–º—è¬ª –æ–±–Ω—É–ª—è–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å, –Ω–æ –Ω–∞–≤—Å–µ–≥–¥–∞ —É—Å–∏–ª–∏–≤–∞–µ—Ç –¥—É—à–∏.
    <br/>–ù—É–∂–µ–Ω –∂—ë—Å—Ç–∫–∏–π —Å–±—Ä–æ—Å? –ù–∞–∂–º–∏ Shift+R.
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // =========================
    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    // =========================
    function fmtShort(n){
      if (!isFinite(n)) return "‚àû";
      const abs = Math.abs(n);
      if (abs < 1000) return n.toFixed(n < 10 ? 2 : 1); // –¥–ª—è –º–∞–ª—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π –≤–∏–¥–Ω–æ –¥–µ—Å—è—Ç—ã–µ/—Å–æ—Ç—ã–µ
      const units = ["k","M","B","T","Qa","Qi","Sx","Sp","Oc","No","Dc"];
      let u = -1;
      while (n >= 1000 && u < units.length - 1){ n /= 1000; u++; }
      const s = n.toFixed(n >= 100 ? 0 : n >= 10 ? 1 : 2);
      return s + units[u];
    }
    function fmtInt(n){
      if (!isFinite(n)) return "‚àû";
      const abs = Math.abs(n);
      if (abs < 1000) return Math.floor(n).toString();
      const units = ["k","M","B","T","Qa","Qi","Sx","Sp","Oc","No","Dc"];
      let u = -1;
      while (n >= 1000 && u < units.length - 1){ n /= 1000; u++; }
      const s = n.toFixed(n >= 100 ? 0 : n >= 10 ? 1 : 2);
      return s + units[u];
    }
    function now(){ return Date.now() }

    function toast(msg, ms=2600){
      const $t = $("#toast");
      $t.stop(true,true).html(msg).fadeIn(160);
      clearTimeout($t.data("hideTimer"));
      $t.data("hideTimer", setTimeout(()=> $t.fadeOut(300), ms));
    }

    // ======================================
    // –ú–æ–¥–µ–ª—å –∏–≥—Ä—ã: —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    // ======================================
    const Game = {
      souls: 0,
      totalSouls: 0, // –≤—Å–µ–≥–æ –∫–æ–≥–¥–∞-–ª–∏–±–æ –ø–æ–ª—É—á–µ–Ω–æ (–¥–ª—è –ø—Ä–µ—Å—Ç–∏–∂–∞)
      soulsPerClickBase: 1,
      soulsPerClickAdd: 0,
      embers: 0, // –≤–∞–ª—é—Ç–∞ –ø—Ä–µ—Å—Ç–∏–∂–∞
      emberBonus: 0, // –º—É–ª—å—Ç–∏–ø–ª–∏–∫–∞—Ç–æ—Ä –æ—Ç —É–≥–ª–µ–π (0.1 = +10%)
      generators: [
        { id:"hollow", name:"–ü–æ–ª–æ–π",        desc:"+0.1 –¥—É—à–∏/—Å–µ–∫", baseSps:0.1,   baseCost: 25,   costMult: 1.15, level:0 },
        { id:"undead", name:"–ù–µ–∂–∏—Ç—å",       desc:"+1 –¥—É—à–∞/—Å–µ–∫",   baseSps:1,     baseCost: 250,  costMult: 1.16, level:0 },
        { id:"knight", name:"–†—ã—Ü–∞—Ä—å",       desc:"+8 –¥—É—à/—Å–µ–∫",    baseSps:8,     baseCost: 1800, costMult: 1.17, level:0 },
        { id:"sorcer", name:"–ö–æ–ª–¥—É–Ω",       desc:"+24 –¥—É—à/—Å–µ–∫",   baseSps:24,    baseCost: 6000, costMult: 1.18, level:0 },
        { id:"keeper", name:"–•—Ä–∞–Ω–∏—Ç–µ–ª—å–Ω–∏—Ü–∞",desc:"+80 –¥—É—à/—Å–µ–∫",   baseSps:80,    baseCost: 22000,costMult: 1.20, level:0 },
      ],
      upgrades: [
        { id:"blade",  name:"–£—Å–∏–ª–∏—Ç—å –æ—Ä—É–∂–∏–µ", desc:"+1 –∫ –¥—É—à–µ –∑–∞ –∫–ª–∏–∫",   add:1,   baseCost: 15,  costMult: 1.22, level:0 },
        { id:"resin",  name:"–°–º–æ–ª–∞ —É–≥–ª–µ–π",    desc:"+25% –∫ –¥—É—à–∞–º –∑–∞ –∫–ª–∏–∫",mult:0.25, baseCost:120, costMult: 1.28, level:0 },
        { id:"brand",  name:"–ö–ª–µ–π–º–æ –ø–ª–∞–º–µ–Ω–∏", desc:"+1 –¥—É—à–∞/–∫–ª–∏–∫/—É—Ä.",    add:1,   baseCost: 500, costMult: 1.3,  level:0 },
      ],
      lastTick: now(),
      lastSave: now(),
      version: 1,
    };

    // ==============
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
    // ==============
    function save(){
      try{
        Game.lastSave = now();
        localStorage.setItem("soulforgeSaveV"+Game.version, JSON.stringify(Game));
      }catch(e){}
    }
    function load(){
      let raw = null;
      try{ raw = localStorage.getItem("soulforgeSaveV"+Game.version); }catch(e){}
      if (!raw) return;
      try{
        const obj = JSON.parse(raw);
        if (typeof obj.souls === "number") Game.souls = obj.souls;
        if (typeof obj.totalSouls === "number") Game.totalSouls = obj.totalSouls || 0;
        if (typeof obj.soulsPerClickBase === "number") Game.soulsPerClickBase = obj.soulsPerClickBase;
        if (typeof obj.soulsPerClickAdd === "number") Game.soulsPerClickAdd = obj.soulsPerClickAdd;
        if (typeof obj.embers === "number") Game.embers = obj.embers || 0;
        if (typeof obj.emberBonus === "number") Game.emberBonus = obj.emberBonus || 0;
        if (Array.isArray(obj.generators)){
          Game.generators.forEach(g=>{
            const f = obj.generators.find(x=>x.id===g.id);
            if (f && typeof f.level==="number") g.level = f.level;
          });
        }
        if (Array.isArray(obj.upgrades)){
          Game.upgrades.forEach(u=>{
            const f = obj.upgrades.find(x=>x.id===u.id);
            if (f && typeof f.level==="number") u.level = f.level;
          });
        }
        if (typeof obj.lastSave === "number") {
          const dt = Math.max(0, now() - obj.lastSave);
          const sps = getSps();
          const offlineSeconds = Math.min(3600*8, dt/1000); // –¥–æ 8 —á–∞—Å–æ–≤ –æ—Ñ–ª–∞–π–Ω–∞
          const gain = sps * offlineSeconds * (1 + Game.emberBonus);
          if (gain > 0.01){
            Game.souls += gain;
            Game.totalSouls += gain;
            toast(`–ü–æ–∫–∞ –≤–∞—Å –Ω–µ –±—ã–ª–æ: +${fmtInt(gain)} –¥—É—à`, 3200);
          }
        }
      }catch(e){
        console.warn("Load failed", e);
      }
    }

    // ============================
    // –†–∞—Å—á—ë—Ç—ã —Ä–µ—Å—É—Ä—Å–æ–≤ –∏ —Å—Ç–æ–∏–º–æ—Å—Ç–µ–π
    // ============================
    function getSpc(){
      const add = Game.soulsPerClickAdd + Game.upgrades.filter(u=>u.add).reduce((a,u)=> a + u.add*u.level, 0);
      const mult = 1 + Game.upgrades.filter(u=>u.mult).reduce((a,u)=> a + u.mult*u.level, 0);
      const emberMult = 1 + Game.emberBonus;
      return (Game.soulsPerClickBase + add) * mult * emberMult;
    }
    function getSps(){
      const base = Game.generators.reduce((a,g)=> a + g.baseSps * g.level, 0);
      const emberMult = 1 + Game.emberBonus;
      return base * emberMult;
    }
    function costFor(item){
      return item.baseCost * Math.pow(item.costMult, item.level);
    }
    function canBuy(cost){ return Game.souls >= cost }

    // =================
    // –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å/—Ä–µ–Ω–¥–µ—Ä
    // =================
    function renderHeader(){
      $("#souls").text(fmtInt(Game.souls));
      $("#spc").text(fmtShort(getSpc()));
      $("#sps").text(fmtShort(getSps()));
      $("#embers").text(fmtInt(Game.embers));

      const diff = embersPotential() - Game.embers; // —Å–∫–æ–ª—å–∫–æ –¥–æ–±–∞–≤–∏—Ç—Å—è
      const canPrestige = diff > 0;
      $("#prestigeBtn")
        .prop("disabled", !canPrestige)
        .text(`–°–≤—è–∑–∞—Ç—å –ü–ª–∞–º—è (+${(diff*10).toFixed(0)}% –¥—É—à–∏) ‚Äî –ü—Ä–µ—Å—Ç–∏–∂`);
    }

    function renderShop(){
      const $shop = $("#shop").empty();

      // Upgrades
      Game.upgrades.forEach(u=>{
        const cost = costFor(u);
        const $it = $(`
          <div class="item">
            <div>
              <div class="name">${u.name} <span class="level">—É—Ä. ${u.level}</span></div>
              <div class="desc">${u.desc}</div>
              <div class="meta">
                <div>–°—Ç–æ–∏–º–æ—Å—Ç—å: <span class="cost">${fmtInt(cost)}</span></div>
              </div>
            </div>
            <div>
              <button class="buy" data-type="upgrade" data-id="${u.id}">–ö—É–ø–∏—Ç—å</button>
            </div>
          </div>
        `);
        $it.find(".buy").prop("disabled", !canBuy(cost));
        $shop.append($it);
      });

      // Generators
      Game.generators.forEach(g=>{
        const cost = costFor(g);
        const spsGain = g.baseSps * (1 + Game.emberBonus);
        const $it = $(`
          <div class="item">
            <div>
              <div class="name">${g.name} <span class="level">—É—Ä. ${g.level}</span></div>
              <div class="desc">${g.desc}</div>
              <div class="meta">
                <div>–°—Ç–æ–∏–º–æ—Å—Ç—å: <span class="cost">${fmtInt(cost)}</span></div>
                <div>–î–∞—Å—Ç: <span class="gain">+${fmtShort(spsGain)}/—Å–µ–∫</span></div>
              </div>
            </div>
            <div>
              <button class="buy" data-type="generator" data-id="${g.id}">–ù–∞–Ω—è—Ç—å</button>
            </div>
          </div>
        `);
        $it.find(".buy").prop("disabled", !canBuy(cost));
        $shop.append($it);
      });
    }

    function addAchievement(id, label){
      if ($("#ach_"+id).length) return;
      const $b = $(`<div class="badge" id="ach_${id}">üèµÔ∏è ${label}</div>`);
      $("#achievements").append($b);
      toast(`–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ: ${label}`);
    }

    function updateAchievements(){
      if (Game.totalSouls >= 1) addAchievement("first", "–ü–µ–ø–µ–ª –∫ –ø–µ–ø–ª—É: –ø–µ—Ä–≤–∞—è –¥—É—à–∞");
      if (Game.totalSouls >= 1000) addAchievement("k", "–¢—ã—Å—è—á–∞ –∏—Å–∫—Ä");
      if (Game.totalSouls >= 1000000) addAchievement("m", "–ñ–∞—Ä–æ–≤–Ω—è –ø—ã–ª–∞–µ—Ç");
      if (Game.generators.find(g=>g.id==="keeper" && g.level>=1)) addAchievement("keeper", "–®—ë–ø–æ—Ç –•—Ä–∞–Ω–∏—Ç–µ–ª—å–Ω–∏—Ü—ã");
      if (Game.embers >= 1) addAchievement("ember1", "–¢–ª–µ—é—â–∏–π —É–≥–æ–ª—å");
      if (Game.embers >= 10) addAchievement("ember10", "–ü–ª–∞–º—è –Ω–µ—É–≥–∞—Å–∏–º–æ");
    }

    // ======================
    // –ò–≥—Ä–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è/—Ü–∏–∫–ª
    // ======================
    function clickBonfire(px, py){
      const gain = getSpc();
      Game.souls += gain;
      Game.totalSouls += gain;

      // –ü–ª–∞–≤–∞—é—â–µ–µ —á–∏—Å–ª–æ
      const $f = $(`<div class="click-float">+${fmtInt(gain)}</div>`);
      const $bf = $("#bonfire");
      $bf.append($f);
      const rect = $bf[0].getBoundingClientRect();
      const x = (px ?? (rect.left + rect.width/2)) - rect.left;
      const y = (py ?? (rect.top + rect.height/2)) - rect.top;
      $f.css({ left: x+"px", top: y+"px" });
      setTimeout(()=> $f.remove(), 820);

      // –ò—Å–∫—Ä—ã
      spawnSparks(6);
    }

    function spawnSparks(n=4){
      const $layer = $("#embersLayer");
      const rect = $layer[0].getBoundingClientRect();
      for (let i=0;i<n;i++){
        const s = $('<div class="ember-spark"></div>');
        const x = rect.width/2 + (Math.random()*24 - 12);
        const y = rect.height/2 + (Math.random()*6 - 3);
        const dx = (Math.random()*60 - 30) + "px";
        const dy = (-60 - Math.random()*40) + "px";
        s.css({ left: x+"px", top: y+"px", "--dx": dx, "--dy": dy });
        $layer.append(s);
        setTimeout(()=> s.remove(), 1100);
      }
    }

    function buyItem(type, id){
      if (type === "upgrade"){
        const u = Game.upgrades.find(x=>x.id===id);
        if (!u) return;
        const cost = costFor(u);
        if (!canBuy(cost)) return;
        Game.souls -= cost;
        u.level += 1;
        if (u.add) Game.soulsPerClickAdd += u.add;
        renderHeader(); renderShop(); save(); updateAchievements();
      } else if (type === "generator"){
        const g = Game.generators.find(x=>x.id===id);
        if (!g) return;
        const cost = costFor(g);
        if (!canBuy(cost)) return;
        Game.souls -= cost;
        g.level += 1;
        renderHeader(); renderShop(); save(); updateAchievements();
      }
    }

    function embersPotential(){
      // –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É–≥–ª–∏ –ø–æ —Ñ–æ—Ä–º—É–ª–µ
      return Math.floor(Math.sqrt(Game.totalSouls / 1e6));
    }

    function prestige(){
      const potential = embersPotential();
      const add = potential - Game.embers;
      if (add <= 0) {
        toast("–°–ª–∏—à–∫–æ–º –º–∞–ª–æ —Ç–ª–µ—é—â–∏—Ö —É–≥–ª–µ–π –¥–ª—è –ø—Ä–µ—Å—Ç–∏–∂–∞.");
        return;
      }
      Game.embers = potential;
      Game.emberBonus = Game.embers * 0.10; // +10% –∑–∞ —É–≥–æ–ª—å

      // –°–±—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞, —É–≥–ª–∏ –∏ –±–æ–Ω—É—Å –æ—Å—Ç–∞—é—Ç—Å—è
      Game.souls = 0;
      Game.soulsPerClickAdd = 0;
      Game.upgrades.forEach(u=> u.level = 0);
      Game.generators.forEach(g=> g.level = 0);

      toast(`–í—ã —Å–≤—è–∑–∞–ª–∏ –ü–ª–∞–º—è: +${(add*10).toFixed(0)}% –∫ –¥—É—à–∞–º –Ω–∞–≤—Å–µ–≥–¥–∞.`);
      renderHeader(); renderShop(); save(); updateAchievements();
    }

    // –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª
    function gameLoop(){
      const t = now();
      const dt = Math.min(250, t - Game.lastTick);
      Game.lastTick = t;

      // –ü—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ –¥—É—à
      const sps = getSps();
      const gain = sps * (dt/1000);
      if (gain > 0){
        Game.souls += gain;
        Game.totalSouls += gain;
      }

      // –ü–∞—Å—Å–∏–≤–Ω—ã–µ –∏—Å–∫—Ä—ã –∏–Ω–æ–≥–¥–∞
      if (Math.random() < 0.06) spawnSparks(1);

      renderHeader();

      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –º–∞–≥–∞–∑–∏–Ω–∞ –Ω–µ –Ω–∞ –∫–∞–∂–¥–æ–º —Ç–∏–∫–µ
      if (Math.random() < 0.25) {
        $("#shop .item").each(function(){
          const $btn = $(this).find(".buy");
          const type = $btn.data("type"); const id = $btn.data("id");
          let obj = (type==="upgrade" ? Game.upgrades : Game.generators).find(x=>x.id===id);
          if (obj){
            const cost = costFor(obj);
            $btn.prop("disabled", !canBuy(cost));
            $(this).find(".level").text("—É—Ä. " + obj.level);
            $(this).find(".cost").text(fmtInt(cost));
          }
        });
      }
    }

    // =================
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI
    // =================
    $(function(){
      // –ï—Å–ª–∏ jQuery –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è, –ø–æ–∫–∞–∂–µ–º –∫–æ—Ä–æ—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      if (typeof $ === "undefined" || !$.fn) {
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å jQuery. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É.");
        return;
      }

      load();
      renderHeader();
      renderShop();
      updateAchievements();

      // –ö–ª–∏–∫ –ø–æ –∫–æ—Å—Ç—Ä—É (–º—ã—à—å)
      $("#bonfire").on("click", function(e){
        clickBonfire(e.offsetX, e.offsetY);
      });

      // –¢–∞—á –ø–æ –∫–æ—Å—Ç—Ä—É (–º–æ–±–∏–ª–∫–∏)
      $("#bonfire").on("touchstart", function(e){
        const rect = this.getBoundingClientRect();
        const touch = e.originalEvent.touches[0];
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;
        clickBonfire(x, y);
      });

      // –ü–æ–∫—É–ø–∫–∏
      $("#shop").on("click", ".buy", function(){
        const type = $(this).data("type");
        const id = $(this).data("id");
        buyItem(type, id);
      });

      // –ü—Ä–µ—Å—Ç–∏–∂
      $("#prestigeBtn").on("click", prestige);

      // –¢–∏–∫–µ—Ä
      setInterval(gameLoop, 100);
      // –ê–≤—Ç–æ—Å–µ–π–≤
      setInterval(save, 10_000);

      // –ì–æ—Ä—è—á–∞—è –∫–ª–∞–≤–∏—à–∞: –ø—Ä–æ–±–µ–ª ‚Äî –∫–ª–∏–∫, Shift+R ‚Äî –ø–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å
      $(document).on("keydown", function(e){
        if (e.code === "Space" && !$(e.target).is("input,textarea")) {
          e.preventDefault();
          const rect = document.getElementById("bonfire").getBoundingClientRect();
          clickBonfire(rect.width/2, rect.height/2);
        } else if (e.shiftKey && (e.key === "R" || e.key === "—Ä")) {
          if (confirm("–°–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å (–≤–∫–ª—é—á–∞—è —É–≥–ª–∏)?")) {
            try{ localStorage.removeItem("soulforgeSaveV"+Game.version); }catch(_){}
            location.reload();
          }
        }
      });

      // –ü–µ—Ä–≤–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
      if ((Game.totalSouls||0) < 1){
        toast("–ö–æ—Å–Ω–∏—Ç–µ—Å—å –∫–æ—Å—Ç—Ä–∞ ‚Äî —Ä–∞–∑–æ–∂–≥–∏—Ç–µ —Ç—å–º—É.");
      }
    });

    // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ —É—Ö–æ–¥–æ–º
    window.addEventListener("beforeunload", save);
  </script>
</body>
</html>
